name: Build
on:
  push:
    branches:
      - "test-ssm-fecth-ga"
      
permissions: write-all
jobs:
  test-ssm-fetch:
    name: Test SSM Fetch
    runs-on: ubuntu-latest
    # needs: tests
    steps:
    - uses: actions/checkout@v3

    - name: Assume InfraDeployGitHub
      uses: aws-actions/configure-aws-credentials@v2
      with:
        aws-region: 'us-west-1'
        # An IAM role with permission to run CDK against all environments, found in our AWS Account "Common"
        role-to-assume: arn:aws:iam::874302534186:role/CIDeployGitHub
        role-duration-seconds: 1800
      
    - name: Retrieve SSM Secret
      shell: bash
      id: ssm-retrieve
      env:
        AWS_REGION: 'us-west-1'
        SECRET_PATH: '/common/github/teleport/teleport-key'
      run: |

        # FETCH SSM SECRET
        SSM_SECRET=$(aws ssm get-parameter --name $SECRET_PATH --query "Parameter.Value" --output text --with-decryption --region $AWS_REGION)

        # echo $SSM_SECRET

        delimiter="$(openssl rand -hex 8)"
        echo "ssm-secret<<${delimiter}" >> "${GITHUB_OUTPUT}"
        echo "$SSM_SECRET" >> "${GITHUB_OUTPUT}"
        echo "${delimiter}" >> "${GITHUB_OUTPUT}"

        # RESOLVE MULTILINE ISSUE DESCRIBED HERE https://github.community/t/set-output-truncates-multiline-strings/16852/5
        # SSM_SECRET="${SSM_SECRET//'%'/'%25'}"
        # echo $SSM_SECRET
        # SSM_SECRET="${SSM_SECRET//$'\n'/'%0A'}"
        # echo $SSM_SECRET
        # SSM_SECRET="${SSM_SECRET//$'\r'/'%0D'}"
        # echo $SSM_SECRET

        # MASKS AND EXPORT CREDENTIALS
        # echo "ssm-secret=$SSM_SECRET" >> $GITHUB_OUTPUT

    - name: Show SSM Secret
      shell: bash
      run: |
        touch temp
        echo "${{steps.ssm-retrieve.outputs.ssm-secret}}" > temp
        cat temp
  